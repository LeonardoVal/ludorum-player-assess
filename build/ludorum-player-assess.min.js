//! ludorum-player-assess 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-assess"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(t,n,a){"use strict";var r=t.raiseIf,o=t.declare,i=t.initialize,s=t.iterable,u=t.Iterable,c=t.Randomness,l=t.Future,f=t.Statistics,m={__package__:"ludorum-player-assess",__name__:"ludorum_player_assess",__init__:e,__dependencies__:[t,n],ludorum:a,__SERMAT__:{include:[t,a]}},h=m.statistics={};m.compare=function(e){r(!e||!e.game,"Missing `game` argument!");var n,o=e.game,i=e.players||[new a.players.RandomPlayer({name:"RandomPlayer"})],s=e.opponents||[new a.players.RandomPlayer({name:"__RandomOpponent__"})],u=+e.matchCount||400,c=e.logger,l=i.map(function(e){return new a.tournaments.Measurement(o,e,s,u)});if(c){c.info("Starting "+u*i.length*2+" matches of "+o.name+".");var f=0;l.forEach(function(e){e.events.on("afterMatch",function(){f++})}),n=setInterval(function(){c.info("Played "+f+"/"+u*i.length*2+" matches.")},e.logTime||2e4)}return t.Future.all(l.map(function(e){return e.run()})).then(function(){return c&&(clearInterval(n),c.info("Played "+f+"/"+u*i.length*2+" matches.")),h.fisherWithTournaments({game:o,tournaments:l,logger:c})})};var d=h.hypergeometricRule=function(e,t){var n=0,a=[0,0],r=e.map(function(e,r){return a[0]+=e,a[1]+=t[r],n+=e+t[r],e+t[r]}),o=new Array(n+1);a.concat(r).forEach(function(e){for(var t=2;t<=e;t++)o[t]=1+(0|o[t])}),[n].concat(e,t).forEach(function(e){for(var t=2;t<=e;t++)o[t]=(0|o[t])-1});for(var i=1,s=2,u=2;s<=n||u<=n;)i<=1&&s<=n?(o[s]>0&&(i*=Math.pow(s,o[s])),s++):(o[u]<0&&(i*=Math.pow(u,o[u])),u++);return i};return h.fisher2x2=function(e,t,n){r(2!==e.length||2!==t.length,"Contingency table should be 2x2!"),n=isNaN(n)?.05:+n;var a=e[0],o=e[1],i=t[0],s=t[1],u=a+o,c=i+s,l=a+i,f=Math.abs(a/u-i/c),m=Math.min(u,l),h=0;for(a=0;a<=m;a++)o=u-a,(s=c-(i=l-a))>=0&&Math.abs(a/u-i/c)>=f&&(h+=d([a,o],[i,s]));return{p_value:h,comparison:h>n?0:e[0]-t[0]}},h.fisher2x3=function(e,t,n){r(3!==e.length||3!==t.length,"Contingency table should be 2x3!"),n=isNaN(n)?.05:+n;var a,o,i=e[0],s=e[1],u=e[2],c=t[0],l=t[1],f=t[2],m=i+s+u,h=i+c,p=s+l,y=u+f,_=d([i,s,u],[c,l,f]),g=Math.min(m,h),v=0;for(i=0;i<=g;i++)for(o=Math.min(m-i,p),s=0;s<=o;s++)c=h-i,l=p-s,(f=y-(u=m-i-s))>=0&&(a=d([i,s,u],[c,l,f]))<=_&&(v+=a);return{p_value:v,comparison:v>n?0:e[0]-t[0]||(e[1]-row[1])/(p+1)}},h.fisherWithTournaments=function(e){var n=e.tournaments||e.tournament&&[e.tournament],a=e.game||n[0].game,r=e.players&&e.players.map(function(e){return e.name}),o=isNaN(e.alpha)?.05:+e.alpha,i=e.logger,s=function(e){var n={};return e.forEach(function(e,a){var r=e.statistics;t.iterable(r.__stats__).forEachApply(function(e,t){var a=t.keys.player,r=t.keys.role;n[a]||(n[a]={}),n[a][r]||(n[a][r]=[0,0,0]);var o=n[a][r];"victories"===t.keys.key?o[0]+=t.count():"draws"===t.keys.key?o[1]+=t.count():"defeats"===t.keys.key&&(o[2]+=t.count())})}),n}(n),u={};return i&&i.info("Analyzing tournament results for "+a.name+"."),a.players.forEach(function(e){u[e]||(u[e]={}),t.iterable(Object.keys(s)).combinations(2).forEachApply(function(t,n){if(r?r.indexOf(t)>=0&&r.indexOf(n)>=0:!/^__.*__$/.test(t)&&!/^__.*__$/.test(n)){i&&i.info("Performing Fisher exact test for "+t+" vs "+n+".");var a=s[t][e],c=s[n][e];u[e][t+"|"+n]={"won/lost":h.fisher2x2([a[0],a[2]],[c[0],a[2]],o),"won/tied+lost":h.fisher2x2([a[0],a[1]+a[2]],[c[0],a[2]+a[2]],o),"won<tied>lost":h.fisher2x2([a[0],Math.floor(a[1]/2)+a[2]],[c[0],Math.floor(a[2]/2)+a[2]],o),"won/tied/lost":h.fisher2x3(a,c,o)}}})}),u},m.Scanner=o({constructor:function(e){i(this,e).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:c.DEFAULT}).object("statistics",{defaultValue:new f}).bool("adjustWidth",{defaultValue:!1,coerce:!0})},scan:function(e){var t=this,n=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),a=0;return this.__currentWidth__=this.maxLength,l.whileDo(function(){return n.length>0&&a<t.__currentWidth__},function(){return l.all(n.map(function(n){return t.__advance__(e,n,a)})).then(function(e){return n=s(e).filter(function(e){var n=e.isEmpty();return n&&t.adjustWidth&&t.__currentWidth__--,!n}).flatten().sample(t.__currentWidth__,t.random).toArray(),++a})}).then(function(){return t.statistics.add({key:"aborted"},n.length),t.statistics})},scans:function(){return l.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(e,t,n){if(t.isContingent)return s(t.possibleHaps()).mapApply(function(e,n){return t.next(e)});if(this.account(e,t,n))return u.EMPTY;var a=t.moves(),r=this.statistics;return l.all(t.activePlayers.map(function(n){if(e&&e[n]){var o=e[n],i=r.stat({key:"decision.time",game:t.name,role:n,player:o.name});return i.startTime(),l.when(o.decision(t,n)).then(function(e){return i.addTime(),[[n,e]]})}return a[n].map(function(e){return[n,e]})})).then(function(e){return u.product.apply(u,e).map(function(e){return t.next(s(e).toObject())})})},account:function(e,t,n){var a=t.result(),r=this.statistics;if(a)return s(t.players).forEach(function(o){var i=a[o],s=e&&e[o]?e[o].name:"";r.add({key:"game.result",game:t.name,role:o,player:s},i,t),r.add({key:"game.length",game:t.name,role:o,player:s},n,t),i<0?(r.add({key:"defeat.result",game:t.name,role:o,player:s},i,t),r.add({key:"defeat.length",game:t.name,role:o,player:s},n,t)):i>0?(r.add({key:"victory.result",game:t.name,role:o,player:s},i,t),r.add({key:"victory.length",game:t.name,role:o,player:s},n,t)):r.add({key:"draw.length",game:t.name,role:o,player:s},n,t)}),!0;var o=t.moves();return s(t.activePlayers).forEach(function(e){r.add({key:"game.width",game:t.name,role:e},o[e].length)}),!1},"static scan":function(e){return new this(e).scan(e.players)}}),m});
//# sourceMappingURL=ludorum-player-assess.min.js.map