//! ludorum-player-assess 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-assess"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(t,n,r){"use strict";var a=t.raiseIf,o=t.declare,i=t.initialize,s=t.iterable,u=t.Iterable,c=t.Randomness,l=t.Future,f=t.Statistics,m={__package__:"ludorum-player-assess",__name__:"ludorum_player_assess",__init__:e,__dependencies__:[t,n],ludorum:r,__SERMAT__:{include:[t,r]}},h=m.statistics={},p=h.hypergeometricRule=function(e,t){var n=0,r=[0,0],a=e.map(function(e,a){return r[0]+=e,r[1]+=t[a],n+=e+t[a],e+t[a]}),o=new Array(n+1);r.concat(a).forEach(function(e){for(var t=2;t<=e;t++)o[t]=1+(0|o[t])}),[n].concat(e,t).forEach(function(e){for(var t=2;t<=e;t++)o[t]=(0|o[t])-1});for(var i=1,s=2,u=2;s<=n||u<=n;)i<=1&&s<=n?(o[s]>0&&(i*=Math.pow(s,o[s])),s++):(o[u]<0&&(i*=Math.pow(u,o[u])),u++);return i};h.fisher2x2=function(e,t,n){a(2!==e.length||2!==t.length,"Contingency table should be 2x2!"),n=isNaN(n)?.05:+n;var r=e[0],o=e[1],i=t[0],s=t[1],u=r+o,c=i+s,l=r+i,f=Math.abs(r/u-i/c),m=Math.min(u,l),h=0;for(r=0;r<=m;r++)o=u-r,(s=c-(i=l-r))>=0&&Math.abs(r/u-i/c)>=f&&(h+=p([r,o],[i,s]));return{p_value:h,comparison:h>n?0:e[0]-t[0]}},h.fisher2x3=function(e,t,n){a(3!==e.length||3!==t.length,"Contingency table should be 2x3!"),n=isNaN(n)?.05:+n;var r,o,i=e[0],s=e[1],u=e[2],c=t[0],l=t[1],f=t[2],m=i+s+u,h=i+c,d=s+l,y=u+f,_=p([i,s,u],[c,l,f]),g=Math.min(m,h),v=0;for(i=0;i<=g;i++)for(o=Math.min(m-i,d),s=0;s<=o;s++)c=h-i,l=d-s,(f=y-(u=m-i-s))>=0&&(r=p([i,s,u],[c,l,f]))<=_&&(v+=r);return{p_value:v,comparison:v>n?0:e[0]-t[0]||(e[1]-row[1])/(d+1)}},h.fisherWithTournaments=function(e){var n=e.tournaments||e.tournament&&[e.tournament],r=e.game||n[0].game,a=e.players&&e.players.map(function(e){return e.name}),o=isNaN(e.alpha)?.05:+e.alpha,i=e.logger,s=function(e){var n={};return e.forEach(function(e,r){var a=e.statistics;t.iterable(a.__stats__).forEachApply(function(e,t){var r=t.keys.player,a=t.keys.role;n[r]||(n[r]={}),n[r][a]||(n[r][a]=[0,0,0]);var o=n[r][a];"victories"===t.keys.key?o[0]+=t.count():"draws"===t.keys.key?o[1]+=t.count():"defeats"===t.keys.key&&(o[2]+=t.count())})}),n}(n),u={};return i&&i.info("Analyzing tournament results for "+r.name+"."),r.players.forEach(function(e){u[e]||(u[e]={}),t.iterable(Object.keys(s)).combinations(2).forEachApply(function(t,n){if(a?a.indexOf(t)>=0&&a.indexOf(n)>=0:!/^__.*__$/.test(t)&&!/^__.*__$/.test(n)){i&&i.info("Performing Fisher exact test for "+t+" vs "+n+".");var r=s[t][e],c=s[n][e];u[e][t+"|"+n]={"won/lost":h.fisher2x2([r[0],r[2]],[c[0],r[2]],o),"won/tied+lost":h.fisher2x2([r[0],r[1]+r[2]],[c[0],r[2]+r[2]],o),"won<tied>lost":h.fisher2x2([r[0],Math.floor(r[1]/2)+r[2]],[c[0],Math.floor(r[2]/2)+r[2]],o),"won/tied/lost":h.fisher2x3(r,c,o)}}})}),u},m.Scanner=o({constructor:function(e){i(this,e).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:c.DEFAULT}).object("statistics",{defaultValue:new f}).bool("adjustWidth",{defaultValue:!1,coerce:!0})},scan:function(e){var t=this,n=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),r=0;return this.__currentWidth__=this.maxLength,l.whileDo(function(){return n.length>0&&r<t.__currentWidth__},function(){return l.all(n.map(function(n){return t.__advance__(e,n,r)})).then(function(e){return n=s(e).filter(function(e){var n=e.isEmpty();return n&&t.adjustWidth&&t.__currentWidth__--,!n}).flatten().sample(t.__currentWidth__,t.random).toArray(),++r})}).then(function(){return t.statistics.add({key:"aborted"},n.length),t.statistics})},scans:function(){return l.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(e,t,n){if(t.isContingent)return s(t.possibleHaps()).mapApply(function(e,n){return t.next(e)});if(this.account(e,t,n))return u.EMPTY;var r=t.moves(),a=this.statistics;return l.all(t.activePlayers.map(function(n){if(e&&e[n]){var o=e[n],i=a.stat({key:"decision.time",game:t.name,role:n,player:o.name});return i.startTime(),l.when(o.decision(t,n)).then(function(e){return i.addTime(),[[n,e]]})}return r[n].map(function(e){return[n,e]})})).then(function(e){return u.product.apply(u,e).map(function(e){return t.next(s(e).toObject())})})},account:function(e,t,n){var r=t.result(),a=this.statistics;if(r)return s(t.players).forEach(function(o){var i=r[o],s=e&&e[o]?e[o].name:"";a.add({key:"game.result",game:t.name,role:o,player:s},i,t),a.add({key:"game.length",game:t.name,role:o,player:s},n,t),i<0?(a.add({key:"defeat.result",game:t.name,role:o,player:s},i,t),a.add({key:"defeat.length",game:t.name,role:o,player:s},n,t)):i>0?(a.add({key:"victory.result",game:t.name,role:o,player:s},i,t),a.add({key:"victory.length",game:t.name,role:o,player:s},n,t)):a.add({key:"draw.length",game:t.name,role:o,player:s},n,t)}),!0;var o=t.moves();return s(t.activePlayers).forEach(function(e){a.add({key:"game.width",game:t.name,role:e},o[e].length)}),!1},"static scan":function(e){return new this(e).scan(e.players)}});var d=new r.players.RandomPlayer({name:"__RandomOpponent__"}),y={players:[new r.players.RandomPlayer({name:"RandomPlayer"})],game:new r.games.TicTacToe,opponents:[d],matchCount:400,logger:null,logTime:2e4};function _(e,n){var r,a=0,o=(n=function(e){for(var t in e=e||{},y)e.hasOwnProperty(t)||(e[t]=y[t]);return e}(n)).logger,i={};return e.forEach(function(e){var t=e.game,n=i[t.name]||(i[t.name]={});e.events.on("afterMatch",function(e){a++;var r=t.players.map(function(t){return e.players[t].name}).join(" ");n[r]||(n[r]=[0,0,0]);var o=e.result()[t.players[0]];n[r][o>0?0:0===o?1:2]++})}),o&&(o.info("Running "+e.length+" tournaments."),r=setInterval(function(){o.info("Played "+a+" matches.")},n.logTime)),t.Future.all(e.map(function(e){return e.run()})).then(function(){return o&&(clearInterval(r),o.info("Played "+a+" matches.")),i})}function g(e,n,a,o){e=e||y.players,n=n||y.game,a=a||y.opponents;var i=o&&Math.max(0,o.matchCount)||y.matchCount;return _(e.map(function(e){return new r.tournaments.Measurement(n,e,a,i)}),o).then(function(r){var a={},o=t.iterable(e).select("name").toArray();for(var i in r[n.name])t.iterable(i.split(/\s+/)).zip(n.players).filterApply(function(e,t){return o.indexOf(e)>=0}).forEachApply(function(e,t){a[t]||(a[t]={}),a[t][e]?(a[t][e][0]+=r[n.name][i][0],a[t][e][1]+=r[n.name][i][1],a[t][e][2]+=r[n.name][i][2]):a[t][e]=r[n.name][i]});return r[n.name]=a,r})}return m.config=function(e){for(var t in e=e||{},y)e.hasOwnProperty(t)?y[t]=e[t]:e[t]=y[t];return e},m.measure=function(e){return e=Array.isArray(e)?e:[e],{playing:function(t){return{against:function(n,r){return g(e,t,n,r)},againstRandom:function(n){return g(e,t,[d],n)}}}}},m});
//# sourceMappingURL=ludorum-player-assess.min.js.map