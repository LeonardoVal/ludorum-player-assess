//! ludorum-player-assess 0.0.1

(function(e){"use strict";this["ludorum-player-assess"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(n,t,a){"use strict";var r=n.raiseIf,i=n.declare,o=n.initialize,s=n.iterable,u=n.Iterable,c=n.Randomness,l=n.Future,f=n.Statistics,m={__package__:"ludorum-player-assess",__name__:"ludorum_player_assess",__init__:e,__dependencies__:[n,t],ludorum:a,__SERMAT__:{include:[n,a]}},h=m.statistics={},p=h.hypergeometricRule=function(e,n){var t=0,a=[0,0],r=e.map(function(e,r){return a[0]+=e,a[1]+=n[r],t+=e+n[r],e+n[r]}),i=new Array(t+1);a.concat(r).forEach(function(e){for(var n=2;n<=e;n++)i[n]=1+(0|i[n])}),[t].concat(e,n).forEach(function(e){for(var n=2;n<=e;n++)i[n]=(0|i[n])-1});for(var o=1,s=2,u=2;s<=t||u<=t;)o<=1&&s<=t?(i[s]>0&&(o*=Math.pow(s,i[s])),s++):(i[u]<0&&(o*=Math.pow(u,i[u])),u++);return o};h.fisher2x2=function(e,n,t){r(2!==e.length||2!==n.length,"Contingency table should be 2x2!"),t=isNaN(t)?.05:+t;var a=e[0],i=e[1],o=n[0],s=n[1],u=a+i,c=o+s,l=a+o,f=Math.abs(a/u-o/c),m=Math.min(u,l),h=0;for(a=0;a<=m;a++)i=u-a,(s=c-(o=l-a))>=0&&Math.abs(a/u-o/c)>=f&&(h+=p([a,i],[o,s]));return{p_value:h,comparison:h>t?0:e[0]-n[0]}},h.fisher2x3=function(e,n,t){r(3!==e.length||3!==n.length,"Contingency table should be 2x3!"),t=isNaN(t)?.05:+t;var a,i,o=e[0],s=e[1],u=e[2],c=n[0],l=n[1],f=n[2],m=o+s+u,h=o+c,y=s+l,d=u+f,_=p([o,s,u],[c,l,f]),g=Math.min(m,h),v=0;for(o=0;o<=g;o++)for(i=Math.min(m-o,y),s=0;s<=i;s++)c=h-o,l=y-s,(f=d-(u=m-o-s))>=0&&(a=p([o,s,u],[c,l,f]))<=_&&(v+=a);return{p_value:v,comparison:v>t?0:e[0]-n[0]||(e[1]-row[1])/(y+1)}},h.fisherWithTournaments=function(e){var t=e.tournaments||e.tournament&&[e.tournament],a=e.game||t[0].game,r=e.players&&e.players.map(function(e){return e.name}),i=isNaN(e.alpha)?.05:+e.alpha,o=e.logger,s=function(e){var t={};return e.forEach(function(e,a){var r=e.statistics;n.iterable(r.__stats__).forEachApply(function(e,n){var a=n.keys.player,r=n.keys.role;t[a]||(t[a]={}),t[a][r]||(t[a][r]=[0,0,0]);var i=t[a][r];"victories"===n.keys.key?i[0]+=n.count():"draws"===n.keys.key?i[1]+=n.count():"defeats"===n.keys.key&&(i[2]+=n.count())})}),t}(t),u={};return o&&o.info("Analyzing tournament results for "+a.name+"."),a.players.forEach(function(e){u[e]||(u[e]={}),n.iterable(Object.keys(s)).combinations(2).forEachApply(function(n,t){if(r?r.indexOf(n)>=0&&r.indexOf(t)>=0:!/^__.*__$/.test(n)&&!/^__.*__$/.test(t)){o&&o.info("Performing Fisher exact test for "+n+" vs "+t+".");var a=s[n][e],c=s[t][e];u[e][n+"|"+t]={"won/lost":h.fisher2x2([a[0],a[2]],[c[0],a[2]],i),"won/tied+lost":h.fisher2x2([a[0],a[1]+a[2]],[c[0],a[2]+a[2]],i),"won<tied>lost":h.fisher2x2([a[0],Math.floor(a[1]/2)+a[2]],[c[0],Math.floor(a[2]/2)+a[2]],i),"won/tied/lost":h.fisher2x3(a,c,i)}}})}),u},m.Scanner=i({constructor:function(e){o(this,e).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:c.DEFAULT}).object("statistics",{defaultValue:new f}).bool("adjustWidth",{defaultValue:!1,coerce:!0})},scan:function(e){var n=this,t=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),a=0;return this.__currentWidth__=this.maxLength,l.whileDo(function(){return t.length>0&&a<n.__currentWidth__},function(){return l.all(t.map(function(t){return n.__advance__(e,t,a)})).then(function(e){return t=s(e).filter(function(e){var t=e.isEmpty();return t&&n.adjustWidth&&n.__currentWidth__--,!t}).flatten().sample(n.__currentWidth__,n.random).toArray(),++a})}).then(function(){return n.statistics.add({key:"aborted"},t.length),n.statistics})},scans:function(){return l.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(e,n,t){if(n.isContingent)return s(n.possibleHaps()).mapApply(function(e,t){return n.next(e)});if(this.account(e,n,t))return u.EMPTY;var a=n.moves(),r=this.statistics;return l.all(n.activePlayers.map(function(t){if(e&&e[t]){var i=e[t],o=r.stat({key:"decision.time",game:n.name,role:t,player:i.name});return o.startTime(),l.when(i.decision(n,t)).then(function(e){return o.addTime(),[[t,e]]})}return a[t].map(function(e){return[t,e]})})).then(function(e){return u.product.apply(u,e).map(function(e){return n.next(s(e).toObject())})})},account:function(e,n,t){var a=n.result(),r=this.statistics;if(a)return s(n.players).forEach(function(i){var o=a[i],s=e&&e[i]?e[i].name:"";r.add({key:"game.result",game:n.name,role:i,player:s},o,n),r.add({key:"game.length",game:n.name,role:i,player:s},t,n),o<0?(r.add({key:"defeat.result",game:n.name,role:i,player:s},o,n),r.add({key:"defeat.length",game:n.name,role:i,player:s},t,n)):o>0?(r.add({key:"victory.result",game:n.name,role:i,player:s},o,n),r.add({key:"victory.length",game:n.name,role:i,player:s},t,n)):r.add({key:"draw.length",game:n.name,role:i,player:s},t,n)}),!0;var i=n.moves();return s(n.activePlayers).forEach(function(e){r.add({key:"game.width",game:n.name,role:e},i[e].length)}),!1},"static scan":function(e){return new this(e).scan(e.players)}});var y=new a.players.RandomPlayer({name:"__RandomOpponent__"}),d={players:[new a.players.RandomPlayer({name:"RandomPlayer"})],game:new a.games.TicTacToe,opponents:[y],matchCount:400,logger:null,logTime:2e4};function _(e,t){var a,r=0,i=(t=function(e){for(var n in e=e||{},d)e.hasOwnProperty(n)||(e[n]=d[n]);return e}(t)).logger,o={};return e.forEach(function(e){var n=e.game,t=o[n.name]||(o[n.name]={});e.events.on("afterMatch",function(e){r++;var a=n.players.map(function(n){return e.players[n].name}).join(" ");t[a]||(t[a]=[0,0,0]);var i=e.result()[n.players[0]];t[a][i>0?0:0===i?1:2]++})}),i&&(i.info("Running "+e.length+" tournaments."),a=setInterval(function(){i.info("Played "+r+" matches.")},t.logTime)),n.Future.all(e.map(function(e){return e.run()})).then(function(){return i&&(clearInterval(a),i.info("Played "+r+" matches.")),o})}function g(e,t,r,i){e=e||d.players,t=t||d.game,r=r||d.opponents;var o=i&&Math.max(0,i.matchCount)||d.matchCount;return _(e.map(function(e){return new a.tournaments.Measurement(t,e,r,o)}),i).then(function(a){var r={},i=n.iterable(e).select("name").toArray();for(var o in a[t.name])n.iterable(o.split(/\s+/)).zip(t.players).filterApply(function(e,n){return i.indexOf(e)>=0}).forEachApply(function(e,n){r[n]||(r[n]={}),r[n][e]?(r[n][e][0]+=a[t.name][o][0],r[n][e][1]+=a[t.name][o][1],r[n][e][2]+=a[t.name][o][2]):r[n][e]=a[t.name][o]});return a[t.name]=r,a})}return m.config=function(e){for(var n in e=e||{},d)e.hasOwnProperty(n)?d[n]=e[n]:e[n]=d[n];return e},m.measure=function(e){return e=Array.isArray(e)?e:[e],{playing:function(n){return{against:function(t,a){return g(e,n,t,a)},againstRandom:function(t){return g(e,n,[y],t)}}}}},m});
//# sourceMappingURL=ludorum-player-assess-tag.min.js.map