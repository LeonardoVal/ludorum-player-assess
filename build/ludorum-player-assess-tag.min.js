//! ludorum-player-assess 0.0.1

(function(e){"use strict";this["ludorum-player-assess"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(t,n,a){"use strict";var r=t.raiseIf,i=t.declare,o=t.initialize,s=t.iterable,u=t.Iterable,c=t.Randomness,l=t.Future,f=t.Statistics,m={__package__:"ludorum-player-assess",__name__:"ludorum_player_assess",__init__:e,__dependencies__:[t,n],ludorum:a,__SERMAT__:{include:[t,a]}},h=m.statistics={};m.compare=function(e){r(!e||!e.game,"Missing `game` argument!");var n,i=e.game,o=e.players||[new a.players.RandomPlayer({name:"RandomPlayer"})],s=e.opponents||[new a.players.RandomPlayer({name:"__RandomOpponent__"})],u=+e.matchCount||400,c=e.logger,l=o.map(function(e){return new a.tournaments.Measurement(i,e,s,u)});if(c){c.info("Starting "+u*o.length*2+" matches of "+i.name+".");var f=0;l.forEach(function(e){e.events.on("afterMatch",function(){f++})}),n=setInterval(function(){c.info("Played "+f+"/"+u*o.length*2+" matches.")},e.logTime||2e4)}return t.Future.all(l.map(function(e){return e.run()})).then(function(){return c&&(clearInterval(n),c.info("Played "+f+"/"+u*o.length*2+" matches.")),h.fisherWithTournaments({game:i,tournaments:l})})};var d=h.hypergeometricRule=function(e,t){var n=0,a=[0,0],r=e.map(function(e,r){return a[0]+=e,a[1]+=t[r],n+=e+t[r],e+t[r]}),i=new Array(n+1);a.concat(r).forEach(function(e){for(var t=2;t<=e;t++)i[t]=1+(0|i[t])}),[n].concat(e,t).forEach(function(e){for(var t=2;t<=e;t++)i[t]=(0|i[t])-1});for(var o=1,s=2,u=2;s<=n||u<=n;)o<=1&&s<=n?(i[s]>0&&(o*=Math.pow(s,i[s])),s++):(i[u]<0&&(o*=Math.pow(u,i[u])),u++);return o};return h.fisher2x2=function(e,t,n){r(2!==e.length||2!==t.length,"Contingency table should be 2x2!"),n=isNaN(n)?.05:+n;var a=e[0],i=e[1],o=t[0],s=t[1],u=a+i,c=o+s,l=a+o,f=Math.abs(a/u-o/c),m=Math.min(u,l),h=0;for(a=0;a<=m;a++)i=u-a,(s=c-(o=l-a))>=0&&Math.abs(a/u-o/c)>=f&&(h+=d([a,i],[o,s]));return{p_value:h,comparison:h>n?0:e[0]-t[0]}},h.fisher2x3=function(e,t,n){r(3!==e.length||3!==t.length,"Contingency table should be 2x3!"),n=isNaN(n)?.05:+n;var a,i,o=e[0],s=e[1],u=e[2],c=t[0],l=t[1],f=t[2],m=o+s+u,h=o+c,_=s+l,y=u+f,p=d([o,s,u],[c,l,f]),g=Math.min(m,h),v=0;for(o=0;o<=g;o++)for(i=Math.min(m-o,_),s=0;s<=i;s++)c=h-o,l=_-s,(f=y-(u=m-o-s))>=0&&(a=d([o,s,u],[c,l,f]))<=p&&(v+=a);return{p_value:v,comparison:v>n?0:e[0]-t[0]||(e[1]-row[1])/(_+1)}},h.fisherWithTournaments=function(e){var n=e.tournaments||e.tournament&&[e.tournament],a=e.game||n[0].game,r=e.players&&e.players.map(function(e){return e.name}),i=isNaN(e.alpha)?.05:+e.alpha,o=e.logger,s=function(e){var n={};return e.forEach(function(e,a){var r=e.statistics;t.iterable(r.__stats__).forEachApply(function(e,t){var a=t.keys.player,r=t.keys.role;n[a]||(n[a]={}),n[a][r]||(n[a][r]=[0,0,0]);var i=n[a][r];"victories"===t.keys.key?i[0]+=t.count():"draws"===t.keys.key?i[1]+=t.count():"defeats"===t.keys.key&&(i[2]+=t.count())})}),n}(n),u={};return o&&o.info("Analyzing tournament results for "+a.name+"."),a.players.forEach(function(e){u[e]||(u[e]={}),t.iterable(Object.keys(s)).combinations(2).forEachApply(function(t,n){if(r){if(r.indexOf(t)<0||r.indexOf(n)<0)return}else if(/^__.*__$/.test(t)||/^__.*__$/.test(n))return;o&&o.info("Performing Fisher exact test for "+t+" vs "+n+".");var a=s[t][e],c=s[n][e];u[e][t+"|"+n]={"won/lost":h.fisher2x2([a[0],a[2]],[c[0],a[2]],i),"won/tied+lost":h.fisher2x2([a[0],a[1]+a[2]],[c[0],a[2]+a[2]],i),"won/tied/lost":h.fisher2x3(a,c,i)}})}),u},m.Scanner=i({constructor:function(e){o(this,e).object("game",{ignore:!0}).integer("maxWidth",{defaultValue:1e3,coerce:!0}).integer("maxLength",{defaultValue:50,coerce:!0}).object("random",{defaultValue:c.DEFAULT}).object("statistics",{defaultValue:new f}).bool("adjustWidth",{defaultValue:!1,coerce:!0})},scan:function(e){var t=this,n=arguments.length<2?this.game?[this.game]:[]:Array.prototype.slice.call(arguments,1),a=0;return this.__currentWidth__=this.maxLength,l.whileDo(function(){return n.length>0&&a<t.__currentWidth__},function(){return l.all(n.map(function(n){return t.__advance__(e,n,a)})).then(function(e){return n=s(e).filter(function(e){var n=e.isEmpty();return n&&t.adjustWidth&&t.__currentWidth__--,!n}).flatten().sample(t.__currentWidth__,t.random).toArray(),++a})}).then(function(){return t.statistics.add({key:"aborted"},n.length),t.statistics})},scans:function(){return l.sequence(Array.prototype.slice.call(arguments),this.scan.bind(this))},__advance__:function(e,t,n){if(t.isContingent)return s(t.possibleHaps()).mapApply(function(e,n){return t.next(e)});if(this.account(e,t,n))return u.EMPTY;var a=t.moves(),r=this.statistics;return l.all(t.activePlayers.map(function(n){if(e&&e[n]){var i=e[n],o=r.stat({key:"decision.time",game:t.name,role:n,player:i.name});return o.startTime(),l.when(i.decision(t,n)).then(function(e){return o.addTime(),[[n,e]]})}return a[n].map(function(e){return[n,e]})})).then(function(e){return u.product.apply(u,e).map(function(e){return t.next(s(e).toObject())})})},account:function(e,t,n){var a=t.result(),r=this.statistics;if(a)return s(t.players).forEach(function(i){var o=a[i],s=e&&e[i]?e[i].name:"";r.add({key:"game.result",game:t.name,role:i,player:s},o,t),r.add({key:"game.length",game:t.name,role:i,player:s},n,t),o<0?(r.add({key:"defeat.result",game:t.name,role:i,player:s},o,t),r.add({key:"defeat.length",game:t.name,role:i,player:s},n,t)):o>0?(r.add({key:"victory.result",game:t.name,role:i,player:s},o,t),r.add({key:"victory.length",game:t.name,role:i,player:s},n,t)):r.add({key:"draw.length",game:t.name,role:i,player:s},n,t)}),!0;var i=t.moves();return s(t.activePlayers).forEach(function(e){r.add({key:"game.width",game:t.name,role:e},i[e].length)}),!1},"static scan":function(e){return new this(e).scan(e.players)}}),m});
//# sourceMappingURL=ludorum-player-assess-tag.min.js.map